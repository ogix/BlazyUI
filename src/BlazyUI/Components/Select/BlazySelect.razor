@namespace BlazyUI
@using System.Diagnostics.CodeAnalysis
@using System.Globalization
@typeparam TValue
@inherits BlazyInputBase<TValue>

<select id="@GetFieldId()"
        name="@GetFieldName()"
        class="@ComputedCssClass"
        value="@CurrentValueAsString"
        disabled="@Disabled"
        @onchange="OnChange"
        @attributes="AdditionalAttributes">
    @ChildContent
</select>

@code {
    /// <summary>
    /// The size of the select.
    /// </summary>
    [Parameter]
    public BlazySelectSize Size { get; set; } = BlazySelectSize.Medium;

    /// <summary>
    /// The color of the select.
    /// </summary>
    [Parameter]
    public BlazySelectColor Color { get; set; } = BlazySelectColor.Default;

    /// <summary>
    /// Applies ghost styling (no background).
    /// </summary>
    [Parameter]
    public bool Ghost { get; set; }

    /// <summary>
    /// The options to display in the select. Use &lt;option&gt; elements.
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// Gets or sets the error message used when displaying a parsing error.
    /// </summary>
    [Parameter]
    public string ParsingErrorMessage { get; set; } = "The {0} field could not be parsed.";

    /// <inheritdoc />
    protected override string GetErrorColorClass() => "select-error";

    /// <inheritdoc />
    protected override bool TryParseValueFromString(
        string? value,
        [MaybeNullWhen(false)] out TValue result,
        [NotNullWhen(false)] out string? validationErrorMessage)
    {
        // Special case for bool/bool? since BindConverter reserves bool for conditional attributes
        if (typeof(TValue) == typeof(bool))
        {
            if (bool.TryParse(value, out var boolResult))
            {
                result = (TValue)(object)boolResult;
                validationErrorMessage = null;
                return true;
            }
            result = default!;
            validationErrorMessage = string.Format(CultureInfo.InvariantCulture, ParsingErrorMessage, FieldIdentifier.FieldName);
            return false;
        }

        if (typeof(TValue) == typeof(bool?))
        {
            if (string.IsNullOrEmpty(value))
            {
                result = default!;
                validationErrorMessage = null;
                return true;
            }
            if (bool.TryParse(value, out var boolResult))
            {
                result = (TValue)(object)boolResult;
                validationErrorMessage = null;
                return true;
            }
            result = default!;
            validationErrorMessage = string.Format(CultureInfo.InvariantCulture, ParsingErrorMessage, FieldIdentifier.FieldName);
            return false;
        }

        // Use BindConverter for all other types (string, enum, int, etc.)
        if (BindConverter.TryConvertTo<TValue>(value, CultureInfo.InvariantCulture, out result))
        {
            validationErrorMessage = null;
            return true;
        }

        validationErrorMessage = string.Format(CultureInfo.InvariantCulture, ParsingErrorMessage, FieldIdentifier.FieldName);
        return false;
    }

    /// <inheritdoc />
    protected override string? FormatValueAsString(TValue? value)
    {
        // Special case for bool to ensure lowercase HTML-compatible values
        if (value is bool boolValue)
        {
            return boolValue ? "true" : "false";
        }

        return value?.ToString();
    }

    private string ComputedCssClass => MergeClasses(
        "select",
        SizeClass,
        ColorClass,
        Ghost ? "select-ghost" : null
    );

    private void OnChange(ChangeEventArgs e)
        => CurrentValueAsString = e.Value?.ToString();

    private string SizeClass => Size switch
    {
        BlazySelectSize.ExtraSmall => "select-xs",
        BlazySelectSize.Small => "select-sm",
        BlazySelectSize.Medium => "select-md",
        BlazySelectSize.Large => "select-lg",
        BlazySelectSize.ExtraLarge => "select-xl",
        _ => throw new ArgumentOutOfRangeException(nameof(Size), Size, null)
    };

    private string? ColorClass => Color switch
    {
        BlazySelectColor.Default => null,
        BlazySelectColor.Neutral => "select-neutral",
        BlazySelectColor.Primary => "select-primary",
        BlazySelectColor.Secondary => "select-secondary",
        BlazySelectColor.Accent => "select-accent",
        BlazySelectColor.Info => "select-info",
        BlazySelectColor.Success => "select-success",
        BlazySelectColor.Warning => "select-warning",
        BlazySelectColor.Error => "select-error",
        _ => throw new ArgumentOutOfRangeException(nameof(Color), Color, null)
    };
}
