@namespace BlazyUI
@inherits BlazyComponentBase

<div class="@CssClass" @attributes="AdditionalAttributes">
    <input id="@DrawerId" type="checkbox" class="drawer-toggle"
           checked="@Open" @onchange="OnToggle" />
    <CascadingValue Value="_context">
        @ChildContent
    </CascadingValue>
</div>

@code {
    private BlazyDrawerContext _context = default!;
    private string _drawerId = default!;

    /// <summary>
    /// The unique identifier for the drawer checkbox toggle.
    /// If not provided, a unique ID is auto-generated.
    /// </summary>
    [Parameter]
    public string? Id { get; set; }

    /// <summary>
    /// Whether the drawer is currently open.
    /// </summary>
    [Parameter]
    public bool Open { get; set; }

    /// <summary>
    /// Callback when the drawer open state changes (for two-way binding).
    /// </summary>
    [Parameter]
    public EventCallback<bool> OpenChanged { get; set; }

    /// <summary>
    /// Position of the drawer sidebar. Start (left) or End (right).
    /// </summary>
    [Parameter]
    public BlazyDrawerPosition Position { get; set; } = BlazyDrawerPosition.Start;

    /// <summary>
    /// When true, the drawer is always open on large screens (lg:drawer-open).
    /// </summary>
    [Parameter]
    public bool Responsive { get; set; }

    /// <summary>
    /// The content of the drawer (typically DrawerContent and DrawerSide components).
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// The drawer ID used for the checkbox toggle.
    /// </summary>
    public string DrawerId => _drawerId;

    protected override void OnInitialized()
    {
        _drawerId = Id ?? $"drawer-{Guid.NewGuid():N}";
    }

    protected override void OnParametersSet()
    {
        _context = new BlazyDrawerContext(_drawerId);
    }

    private async Task OnToggle(ChangeEventArgs e)
    {
        var isOpen = (bool)(e.Value ?? false);
        if (Open != isOpen)
        {
            Open = isOpen;
            await OpenChanged.InvokeAsync(isOpen);
        }
    }

    private string CssClass => MergeClasses(
        "drawer",
        PositionClass,
        ResponsiveClass
    );

    private string? PositionClass => Position switch
    {
        BlazyDrawerPosition.Start => null,
        BlazyDrawerPosition.End => "drawer-end",
        _ => throw new ArgumentOutOfRangeException(nameof(Position), Position, null)
    };

    private string? ResponsiveClass => Responsive ? "lg:drawer-open" : null;
}
